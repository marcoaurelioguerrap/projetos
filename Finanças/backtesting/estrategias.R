#### Estratégias ####




estrategias <- list()

# 1) Venda de PUT fora do preco (prob de nao exercicio = 80%) e CALL coberto simples ( sem recompra ) #######

# estrategia_1_1 : Vende Put fora do preco. Se exercido vende call no preco de compra da acao.
# Usa uma cobb-douglas para identificar a put baseado na media geometrica entre a probabilidade (b = .85)
#e o premio/strike desejavel (a = .15). Apenas puts com Probabilidade de exercicio menor que 20%.
# 

estrategia_1_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_1_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_1_2 : Vende Put fora do preco. Se exercido vende call no preco de compra da acao.
# Usa uma cobb-douglas para identificar a put baseado na media geometrica entre a probabilidade (b = .70)
#e o premio/strike desejavel (a = .30). Apenas puts com Probabilidade de exercicio menor que 20%.
# 
estrategia_1_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado)
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.30 * (P(!exercicio))^0.7
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS )]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  # vende call se tiver acao
  
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_1_2']] <<- CARTEIRA
  #return(carteira)
  
}

# estrategia_1_3 : Vende Put fora do preco. Se exercido vende call no preco de compra da acao.
# Usa uma cobb-douglas para identificar a put baseado na media geometrica entre a probabilidade (b = .60)
#e o premio/strike desejavel (a = .40). Apenas puts com Probabilidade de exercicio menor que 20%.
# 
estrategia_1_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado)
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.30 * (P(!exercicio))^0.7
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS )]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  # vende call se tiver acao
  
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_1_3']] <<- CARTEIRA
  #return(carteira)
  
}

# estrategia_1_4 : Vende Put fora do preco. Se exercido vende call no preco de compra da acao.
# Usa uma cobb-douglas para identificar a put baseado na media geometrica entre a probabilidade (b = .50)
#e o premio/strike desejavel (a = .50). Apenas puts com Probabilidade de exercicio menor que 20%.
# 
estrategia_1_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado)
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.30 * (P(!exercicio))^0.7
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS )]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  # vende call se tiver acao
  
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_1_4']] <<- CARTEIRA
  #return(carteira)
  
}

#####


# 2) Venda de PUT fora do preco (prob de nao exercicio = 80%) e de CALL coberto com recompra de PUT pózinho #####

# estrategia_2_1 : Vende Put fora do preco.Se o preco do put vendido fica menor que 0.02, compra de volta. Se exercido 
#vende call no preco de compra da acao.  Usa uma cobb-douglas para identificar a put com a probabilidade (b = .85)
#e o premio/strike desejavel (a = .15).Apenas puts com Probabilidade de exercicio menor que 20%.
# 

estrategia_2_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # confere se tem put na carteira para poder comprar 
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                              as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                     (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                               as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                              (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
  
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  # Para venda de put nao utilizo preco simulado para diminuir o erro do backtesting
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  print(PUTS_DIA_LIMPO)
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  print(length(qtde) != 0)
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  
  
  
  
  
  # fazer para call!!!!!!!!
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
 
  carteiras[['estrategia_2_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_2_2 : Vende Put fora do preco.Se o preco do put vendido fica menor que 0.02, compra de volta. Se exercido 
#vende call no preco de compra da acao.  Usa uma cobb-douglas para identificar a put com a probabilidade (b = .70)
#e o premio/strike desejavel (a = .30). Apenas puts com Probabilidade de exercicio menor que 20%.
# 

estrategia_2_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # confere se tem put na carteira para poder comprar 
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  # Para venda de put nao utilizo preco simulado para diminuir o erro do backtesting
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  print(PUTS_DIA_LIMPO)
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  print(length(qtde) != 0)
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  
  
  
  
  
  # fazer para call!!!!!!!!
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_2_2']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_2_3 : Vende Put fora do preco.Se o preco do put vendido fica menor que 0.02, compra de volta. Se exercido 
#vende call no preco de compra da acao.  Usa uma cobb-douglas para identificar a put com a probabilidade (b = .60)
#e o premio/strike desejavel (a = .40). Apenas puts com Probabilidade de exercicio menor que 20%.
# 

estrategia_2_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # confere se tem put na carteira para poder comprar 
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  # Para venda de put nao utilizo preco simulado para diminuir o erro do backtesting
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  print(PUTS_DIA_LIMPO)
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  print(length(qtde) != 0)
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  
  
  
  
  
  # fazer para call!!!!!!!!
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_2_3']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_2_4 : Vende Put fora do preco.Se o preco do put vendido fica menor que 0.02, compra de volta. Se exercido 
#vende call no preco de compra da acao.  Usa uma cobb-douglas para identificar a put com a probabilidade (b = .50)
#e o premio/strike desejavel (a = .50). Apenas puts com Probabilidade de exercicio menor que 20%.
# 

estrategia_2_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # confere se tem put na carteira para poder comprar 
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  # Para venda de put nao utilizo preco simulado para diminuir o erro do backtesting
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  print(PUTS_DIA_LIMPO)
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  print(length(qtde) != 0)
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  
  
  
  
  
  # fazer para call!!!!!!!!
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_2_4']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

#####


# 3) Venda de PUT fora do preco (prob de nao exercicio = 80%) e de CALL coberto com recompra de PUT e CALL pózinho #####

# estrategia_3_1 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .85) e o premio/strike desejavel (a = .15).
# Apenas puts com Probabilidade de exercicio menor que 20%.
# 

estrategia_3_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_3_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_3_2 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .70) e o premio/strike desejavel (a = .30).
# Apenas puts com Probabilidade de exercicio menor que 20%.

estrategia_3_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_3_2']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_3_3 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .60) e o premio/strike desejavel (a = .40).
# Apenas puts com Probabilidade de exercicio menor que 20%.

estrategia_3_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_3_3']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_3_4 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .50) e o premio/strike desejavel (a = .50).
# Apenas puts com Probabilidade de exercicio menor que 20%.

estrategia_3_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_3_4']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

#####

# 4) Venda de PUT fora do preco (prob de nao exercicio = 80%) e de CALL coberto com recompra de PUT e CALL pózinho. Compra mesma quantidade de PUT fora do preco (prob de nao exercicio = 90%)
# como HEDGE. #####

# estrategia_4_1 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .85) e o premio/strike desejavel (a = .15).
# Apenas puts com Probabilidade de exercicio menor que 20%.  Compra de PUT, mesma quantidade de venda, com probabilidade
# de exercicio próximo a 90%. Não leva em conta o vencimento

estrategia_4_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_4_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_4_2 : Vende PUTfora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .70) e o premio/strike desejavel (a = .30).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, mesma quantidade de venda, com probabilidade
# de exercicio próximo a 90%.
# 

estrategia_4_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_4_2']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_4_3 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .60) e o premio/strike desejavel (a = .40).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, mesma quantidade de venda, com probabilidade
# de exercicio próximo a 90%.

estrategia_4_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_4_3']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_4_4 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .50) e o premio/strike desejavel (a = .50).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, mesma quantidade de venda, com probabilidade
# de exercicio próximo a 90%.

estrategia_4_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_4_4']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

#####

# 5) Venda de PUT fora do preco (prob de nao exercicio = 80%) e de CALL coberto com recompra de PUT e CALL pózinho. Compra o dobro da quantidade de PUT fora do preco (prob de nao exercicio = 90%) 
# como HEDGE. #####

# estrategia_5_1 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .85) e o premio/strike desejavel (a = .15).
# Apenas puts com Probabilidade de exercicio menor que 20%.  Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 90%. Não leva em conta o vencimento

estrategia_5_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_5_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_5_2 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .70) e o premio/strike desejavel (a = .30).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 90%.
# 

estrategia_5_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_5_2']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_5_3 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .60) e o premio/strike desejavel (a = .40).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 90%.

estrategia_5_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_5_3']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_5_4 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .50) e o premio/strike desejavel (a = .50).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 90%.

estrategia_5_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_5_4']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

#####

# 6) Venda de PUT fora do preco (prob de nao exercicio = 80%) e de CALL coberto com recompra de PUT e CALL pózinho. Compra o dobro da quantidade de PUT fora do preco (prob de nao exercicio = 99%) 
# como HEDGE. #####

# estrategia_6_1 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .85) e o premio/strike desejavel (a = .15).
# Apenas puts com Probabilidade de exercicio menor que 20%.  Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 99%. Não leva em conta o vencimento

estrategia_6_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_6_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_6_2 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .70) e o premio/strike desejavel (a = .30).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 99%.
# 

estrategia_6_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_6_2']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_6_3 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .60) e o premio/strike desejavel (a = .40).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 99%.

estrategia_6_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_6_3']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_6_4 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .50) e o premio/strike desejavel (a = .50).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 99%.

estrategia_6_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_6_4']] <<- CARTEIRA
  #return(CARTEIRA)
  
}


#####

# 7) Venda de PUT fora do preco (prob de nao exercicio = 80%) e de CALL coberto com recompra de PUT e CALL pózinho. Compra mesma quantidade de PUT fora do preco (prob de nao exercicio = 90%)
# como HEDGE. Compra de call na mesma quantidade de PUT fora do preço (prob de nao exercicio = 90%)  #####

# estrategia_7_1 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .85) e o premio/strike desejavel (a = .15).
# Apenas puts com Probabilidade de exercicio menor que 20%.  Compra de PUT e CALL, mesma quantidade de venda, com probabilidade
# de exercicio próximo a 90%. Não leva em conta o vencimento

estrategia_7_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro #####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  #####
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao #####
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
      
    }
    
  }
  #####
  
  
  
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_7_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_7_2 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .70) e o premio/strike desejavel (a = .30).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT e CALL, mesma quantidade de venda, com probabilidade
# de exercicio próximo a 90%.
# 

estrategia_7_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro #####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  #####
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao 
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_7_2']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_7_3 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .60) e o premio/strike desejavel (a = .40).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT e CALL, mesma quantidade de venda, com probabilidade
# de exercicio próximo a 90%.

estrategia_7_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro #####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  #####
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_7_3']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_7_4 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .50) e o premio/strike desejavel (a = .50).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT e CALL, mesma quantidade de venda, com probabilidade
# de exercicio próximo a 90%.

estrategia_7_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro #####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  #####
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_7_4']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

#####

# 8) Venda de PUT fora do preco (prob de nao exercicio = 80%) e de CALL coberto com recompra de PUT e CALL pózinho. Compra o dobro da quantidade de PUT fora do preco (prob de nao exercicio = 90%) 
# como HEDGE. Compra de call na mesma quantidade de PUT fora do preço (prob de nao exercicio = 90%)  #####

# estrategia_8_1 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .85) e o premio/strike desejavel (a = .15).
# Apenas puts com Probabilidade de exercicio menor que 20%.  Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 90%. Compra de CALL, na mesma quantidade de venda, com probabilidade de exercicio próximo a 90%.
# Não leva em conta o vencimento

estrategia_8_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro #####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  #####
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_8_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_8_2 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .70) e o premio/strike desejavel (a = .30).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 90%.Compra de CALL, na mesma quantidade de venda, com probabilidade de exercicio próximo a 90%.
# Não leva em conta o vencimento
# 

estrategia_8_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro #####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  #####
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_8_2']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_8_3 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .60) e o premio/strike desejavel (a = .40).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 90%. Compra de CALL, na mesma quantidade de venda, com probabilidade de exercicio próximo a 90%.
# Não leva em conta o vencimento

estrategia_8_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro #####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...") 
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_8_3']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_8_4 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .50) e o premio/strike desejavel (a = .50).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 90%. Compra de CALL, na mesma quantidade de venda, com probabilidade de exercicio próximo a 90%.
# Não leva em conta o vencimento

estrategia_8_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro #####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  ######
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_8_4']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

#####

# 9) Venda de PUT fora do preco (prob de nao exercicio = 80%) e de CALL coberto com recompra de PUT e CALL pózinho. Compra o dobro da quantidade de PUT fora do preco (prob de nao exercicio = 99%) 
# como HEDGE. Compra de call na mesma quantidade de PUT fora do preço (prob de nao exercicio = 90%)  #####

# estrategia_9_1 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .85) e o premio/strike desejavel (a = .15).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 99%. Compra de CALL, na mesma quantidade de venda, com probabilidade de exercicio próximo a 90%.
# Não leva em conta o vencimento. Não leva em conta o vencimento. 

estrategia_9_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.15 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.85 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_9_1']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_9_2 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .70) e o premio/strike desejavel (a = .30).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 99%. Compra de CALL, na mesma quantidade de venda, com probabilidade de exercicio próximo a 90%.
# Não leva em conta o vencimento
# 

estrategia_9_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.30 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.70 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_9_2']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_9_3 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .60) e o premio/strike desejavel (a = .40).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 99%. Compra de CALL, na mesma quantidade de venda, com probabilidade de exercicio próximo a 90%.
# Não leva em conta o vencimento

estrategia_9_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.40 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.60 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...") 
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_9_3']] <<- CARTEIRA
  #return(CARTEIRA)
  
}

# estrategia_9_4 : Vende PUT fora do preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do PUT vendido fica menor que 0.02, compra de volta. Usa uma
# cobb-douglas para identificar a put com a probabilidade (b = .50) e o premio/strike desejavel (a = .50).
# Apenas puts com Probabilidade de exercicio menor que 20%. Compra de PUT, dobro da quantidade de venda, com probabilidade
# de exercicio próximo a 99%. Compra de CALL, na mesma quantidade de venda, com probabilidade de exercicio próximo a 90%.
# Não leva em conta o vencimento

estrategia_9_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  # parametros da restricao
  prob_maior_igual <- .8
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0) ) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # COBB_DOUGLAS = (premio/strike)^0.15 * (P(!exercicio))^0.85
  
  PUTS_DIA_LIMPO$COBB_DOUGLAS <- as.numeric(PUTS_DIA_LIMPO$premio_porcentagem_strike) ^.50 * 
    as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia) ^.50 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]
  
  # TESTANDO : CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia
  # antigo :  CARTEIRA$cash - CARTEIRA$garantia
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.max(PUTS_DIA_LIMPO$COBB_DOUGLAS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
      }
    }
  }
  
  
  #CARTEIRA <<- CARTEIRA
  # vende call se tiver acao
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para hedge de calda superior #####
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
      
    }
    
  }
  
  #carteira <<- CARTEIRA
  
  # Compra de volta opcoes baratas
  
  # Pega o ultimo preco atual ou o simulado
  #preco_do_put <- as.numeric(carteira$portifolio$puts$data_ult_atualizacao == 0) * as.numeric(carteira$portifolio$puts$preco_atual) +
  #               as.numeric(carteira$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(carteira$portifolio$puts$preco_BAW)
  
  # separa os puts que viraram pó e compra de volta
  
  
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  #print(CARTEIRA$garantia)
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  #print(environment())
  #print(deparse(match.call()$carteira))
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  
  carteiras[['estrategia_9_4']] <<- CARTEIRA
  #return(CARTEIRA)
  
}


#####

# 10) Venda de PUT no preco e CALL coberto com recompra de PUT e CALL pózinho #####

# estrategia_10_1 : Vende PUT no preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do CALL vendido fica menor que 0.02, compra de volta.

estrategia_10_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado)
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  
  # parametros da restricao
  prob_maior_igual <- .30
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  # Define como é ordenados os puts para a escolha de venda:
  # dis = |preco_da_acao - preco_do_strike|
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # separa qtde de acordo com lote minimo, no caso 100
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)
  
  # vende put se tem dinheiro 
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        print(paste0("...Vendeu Put...",qtde))
      }
    }
  }
  
  # vende call se tiver  ( para cada lote)
  
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
    }
    
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_10_1']] <<- CARTEIRA
  #return(carteira)
  
}

# estrategia_10_2 : Vende PUT no preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do CALL vendido fica menor que 0.02, compra de volta. Compra de PUT, 
# dobro da quantidade de venda, com probabilidade de exercicio próximo a 90%. Compra de CALL, na mesma quantidade de 
# venda, com probabilidade de exercicio próximo a 90%.Não leva em conta o vencimento.

estrategia_10_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  
  # confere se tem CALL na carteira para poder comprar ######
  
  if (nrow(CARTEIRA$portifolio$calls) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_call_pra_vender <- any((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$calls$preco_atual <= 0.02 )) |
                                  as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$calls$preco_BAW <= 0.02) ) &
                                 as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )
  } else {
    tem_call_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_call_pra_vender   ){
    
    CARTEIRA$portifolio$calls[which(((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual) <= 0.02 )) | 
                                       (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02)) &
                                      as.numeric(CARTEIRA$portifolio$calls$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$calls[which((as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$calls$preco_atual)<= 0.02 )) | 
                                                           (as.numeric(CARTEIRA$portifolio$calls$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$calls$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de CALL'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_call(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), CALLS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # confere se tem PUT na carteira para poder comprar #####
  
  if (nrow(CARTEIRA$portifolio$puts) > 0){
    # checa se tem put vendido com o preco simulado ( caso nao tenha liquidez) ou preco observado a baixo de 0.02
    tem_put_pra_vender <- any((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) * (as.numeric(CARTEIRA$portifolio$puts$preco_atual <= 0.02 )) |
                                 as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) * as.numeric(CARTEIRA$portifolio$puts$preco_BAW <= 0.02) ) &
                                as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )
  } else {
    tem_put_pra_vender <- FALSE
  }
  
  # se tem put, avalia se tem preco observado ou tem que pegar preco simulado para vender o put
  
  if (  tem_put_pra_vender   ){
    
    CARTEIRA$portifolio$puts[which(((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual) <= 0.02 )) | 
                                      (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02)) &
                                     as.numeric(CARTEIRA$portifolio$puts$qtde < 0) )   ,]
    
    opcoes_para_venda <- CARTEIRA$portifolio$puts[which((as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao == 0) & (as.numeric(CARTEIRA$portifolio$puts$preco_atual)<= 0.02 )) | 
                                                          (as.numeric(CARTEIRA$portifolio$puts$data_ult_atualizacao != 0) & as.numeric(CARTEIRA$portifolio$puts$preco_BAW) <= 0.02))   ,]
    
    # FAZENDO ! fazer loop iterando nas opcoes para venda
    
    for( opcao_a_venda in 1:nrow(opcoes_para_venda) ){
      print(paste0('Fechando posicao de put'))
      #print(opcoes_para_venda$ativo[opcao_a_venda])
      #print(opcoes_para_venda$qtde[opcao_a_venda])
      CARTEIRA <- compra_vende_put(as.character(opcoes_para_venda$ativo[opcao_a_venda]), -as.numeric(opcoes_para_venda$qtde[opcao_a_venda]), PUTS_DIA, CARTEIRA)
      
    }
  }
  
  ########
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado)
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
  #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
  
  
  # Define como é ordenados os puts para a escolha de venda:
  # dis = |preco_da_acao - preco_do_strike|
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # separa qtde de acordo com lote minimo, no caso 100
  qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)
  
  # vende put se tem dinheiro ####
  if ( length(qtde) != 0 ){
    
    # garante que tenha ordem de compra
    if (qtde != 0 ){
      # condicional de se tem dinheiro na carteira
      if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*qtde ) )  {
        CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
        
        print(paste0("...Vendeu Put...",qtde))
        
        # olha os puts pra fazer hedge de calda . prob de exercicio < 90%
        ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.99 ))])
        
        if( ticket_put_compra !=  ticket_put ){
          
          print(" ...comprando puts pra fazer hedge de calda ... ")
          
          CARTEIRA <- compra_vende_put(ticket_put_compra,qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Comprou Put...",qtde))
        }
        
        
        
      }
    }
  }
  
  ######
  
  # vende call se tiver  ( para cada lote) #####
  
  if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
    
    CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
    
    for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Vendeu call...")
      
      # compra call para fazer hedge de calda superior
      
      ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
      
      qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
      
      print("...Comprou Call...")
    }
    
  }
  
  ######
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  # colocando preço corrigido
  # TODO : colocar generalizdo 
  Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
  Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_10_2']] <<- CARTEIRA
  #return(carteira)
  
}

# estrategia_10_3 : Vende PUT no preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do CALL vendido fica menor que 0.02, compra de volta. Compra de PUT, 
# dobro da quantidade de venda, com probabilidade de exercicio próximo a 90%. Compra de CALL, na mesma quantidade de 
# venda, com probabilidade de exercicio próximo a 90%.Não leva em conta o vencimento.

estrategia_10_3 <- 
  function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
    
    # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado)
    PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
    
    CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
    
    # parametros da restricao
    prob_maior_igual <- .01
    premio_maior_igual <- .01
    
    PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (PUTS_DIA$dias_para_vencimento != 0 )) , ] 
    
    #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
    #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
    #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
    
    
    PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
    
    ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
    
    # separa qtde de acordo com lote minimo, no caso 100
    qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)
    
    # vende put se tem dinheiro #####
    if ( length(qtde) != 0 ){
      
      # garante que tenha ordem de compra
      if (qtde != 0 ){
        # condicional de se tem dinheiro na carteira
        if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*qtde ) )  {
          
          CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Vendeu Put...",qtde))
          
          # olha os puts pra fazer hedge de calda
          ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
          
          if( ticket_put_compra !=  ticket_put ){
            
            print(" ...comprando puts pra fazer hedge de calda ... ")
            
            CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde))
          }
          
          
          
        }
      }
    }
    
    ######
    
    # vende call se tiver  ( para cada lote) ########
    
    if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
      
      CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
      
      for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
        
        ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
        
        qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
        
        CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
        
        print("...Vendeu call...")
        
        # compra call 
        
        ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
        
        qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
        
        CARTEIRA <- compra_vende_call(ticket_call,qtde,CALLS_DIA_LIMPO,CARTEIRA)
        
        print("...Comprou Call...")
      }
      
    }
    
    #######
    
    # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
    
    if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
      CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
      print("...calculou garantia...")
    } else {
      CARTEIRA$garantia <- 0
    }
    # finalizando
    
    CARTEIRA$dia <- data
    
    # colocando preço corrigido
    # TODO : colocar generalizdo 
    Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
    Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
    
    
    #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
    carteiras[['estrategia_10_3']] <<- CARTEIRA
    #return(carteira)
    
  }

# estrategia_10_4 : Vende PUT no preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do CALL vendido fica menor que 0.02, compra de volta. Compra de PUT, 
# dobro da quantidade de venda, com probabilidade de exercicio próximo a 90%. Compra de CALL, dobro da quantidade de 
# venda, com probabilidade de exercicio próximo a 90%.Não leva em conta o vencimento.

estrategia_10_4 <- 
  function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
    
    # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado)
    PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
    
    CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
    
    # parametros da restricao
    prob_maior_igual <- .01
    premio_maior_igual <- .01
    
    PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (PUTS_DIA$dias_para_vencimento != 0 )) , ] 
    
    #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
    #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
    #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
    
    
    PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
    
    ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
    
    # separa qtde de acordo com lote minimo, no caso 100
    qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)
    
    # vende put se tem dinheiro #####
    if ( length(qtde) != 0 ){
      
      # garante que tenha ordem de compra
      if (qtde != 0 ){
        # condicional de se tem dinheiro na carteira
        if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*qtde ) )  {
          
          CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Vendeu Put...",qtde))
          
          # olha os puts pra fazer hedge de calda
          ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
          
          if( ticket_put_compra !=  ticket_put ){
            
            print(" ...comprando puts pra fazer hedge de calda ... ")
            
            CARTEIRA <- compra_vende_put(ticket_put_compra,2*qtde,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde))
          }
          
          
          
        }
      }
    }
    
    ######
    
    # vende call se tiver  ( para cada lote) ########
    
    if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
      
      CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
      
      for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
        
        ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
        
        qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
        
        CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
        
        print("...Vendeu call...")
        
        # compra call 
        
        ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
        
        qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
        
        CARTEIRA <- compra_vende_call(ticket_call,2*qtde,CALLS_DIA_LIMPO,CARTEIRA)
        
        print("...Comprou Call...")
      }
      
    }
    
    #######
    
    # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
    
    if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
      CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
      print("...calculou garantia...")
    } else {
      CARTEIRA$garantia <- 0
    }
    # finalizando
    
    CARTEIRA$dia <- data
    
    # colocando preço corrigido
    # TODO : colocar generalizdo 
    Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
    Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
    
    
    #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
    carteiras[['estrategia_10_4']] <<- CARTEIRA
    #return(carteira)
    
  }


# estrategia_10_5 : Vende PUT no preco.Se o preco do PUT vendido fica menor que 0.02, compra de volta. Se exercido 
# vende call no preco de compra da acao. Se o preco do CALL vendido fica menor que 0.02, compra de volta. Compra de PUT, 
# triplo da quantidade de venda, com probabilidade de exercicio próximo a 90%. Compra de CALL, dobro da quantidade de 
# venda, com probabilidade de exercicio próximo a 90%.Não leva em conta o vencimento.

estrategia_10_5 <- 
  function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
    
    # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado)
    PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
    
    CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
    
    # parametros da restricao
    prob_maior_igual <- .01
    premio_maior_igual <- .01
    
    PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (PUTS_DIA$dias_para_vencimento != 0 )) , ] 
    
    #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
    #                                     (PUTS_DIA$premio_porcentagem_strike >= premio_maior_igual) & 
    #                                     (PUTS_DIA$prob_de_nao_exercer != "NÃO_CALCULADO") ), ]
    
    
    PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
    
    ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
    
    # separa qtde de acordo com lote minimo, no caso 100
    qtde <- as.numeric(floor( ( CARTEIRA$cash - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)
    
    # vende put se tem dinheiro #####
    if ( length(qtde) != 0 ){
      
      # garante que tenha ordem de compra
      if (qtde != 0 ){
        # condicional de se tem dinheiro na carteira
        if ( (( CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia ) >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*qtde ) )  {
          
          CARTEIRA <- compra_vende_put(ticket_put,-qtde,PUTS_DIA,CARTEIRA)
          
          print(paste0("...Vendeu Put...",qtde))
          
          # olha os puts pra fazer hedge de calda
          ticket_put_compra <- as.character( PUTS_DIA_LIMPO$ativo[which.min(abs(as.numeric(PUTS_DIA_LIMPO$prob_de_nao_exercer_no_dia)-.9 ))])
          
          if( ticket_put_compra !=  ticket_put ){
            
            print(" ...comprando puts pra fazer hedge de calda ... ")
            
            CARTEIRA <- compra_vende_put(ticket_put_compra,3*qtde,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde))
          }
          
          
          
        }
      }
    }
    
    ######
    
    # vende call se tiver  ( para cada lote) ########
    
    if ( nrow(CARTEIRA$portifolio$acoes) != 0 & !any( CARTEIRA$portifolio$calls$ativo != CARTEIRA$portifolio$acoes$ativo )){
      
      CALLS_DIA_LIMPO <- CALLS_DIA[ which(CALLS_DIA$data != CALLS_DIA$vencimento ) ,]
      
      for ( ativo_subjacente in 1:nrow(CARTEIRA$portifolio$acoes)  ){ 
        
        ticket_call <- CALLS_DIA_LIMPO[ which.min(  (c(CARTEIRA$portifolio$acoes$preco_compra[ativo_subjacente]) - as.numeric(CALLS_DIA_LIMPO$strike))^2  ), "ativo" ]
        
        qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
        
        CARTEIRA <- compra_vende_call(ticket_call,-qtde,CALLS_DIA_LIMPO,CARTEIRA)
        
        print("...Vendeu call...")
        
        # compra call 
        
        ticket_call <- CALLS_DIA_LIMPO[ which.min(  abs(as.numeric(CALLS_DIA_LIMPO$prob_de_nao_exercer_no_dia) - .90)), "ativo" ]
        
        qtde <- CARTEIRA$portifolio$acoes$qtde[ativo_subjacente]
        
        CARTEIRA <- compra_vende_call(ticket_call,2*qtde,CALLS_DIA_LIMPO,CARTEIRA)
        
        print("...Comprou Call...")
      }
      
    }
    
    #######
    
    # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
    
    if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
      CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
      print("...calculou garantia...")
    } else {
      CARTEIRA$garantia <- 0
    }
    # finalizando
    
    CARTEIRA$dia <- data
    
    # colocando preço corrigido
    # TODO : colocar generalizdo 
    Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$acoes$data]*CARTEIRA$portifolio$acoes$preco_compra
    Preco_corrigido_puts <-  Fator_correcao_TEMPORARIO[data]- Fator_correcao_TEMPORARIO[CARTEIRA$portifolio$puts$data]
    
    
    #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
    carteiras[['estrategia_10_5']] <<- CARTEIRA
    #return(carteira)
    
  }

#####
  
# 11) Venda de acao seguindo previsao do RETORNO pelo GARCH ####

estrategia_11_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  dia_previsto <- 1
  
  # Vende posição long
  # short é fechando automaticamente
  if (nrow(CARTEIRA$portifolio$acoes)>0 ){
    
    qtde <- as.numeric(CARTEIRA$portifolio$acoes$qtde)
    
    CARTEIRA <- compra_vende_acao("PETR4" ,data,-qtde,CARTEIRA)
    
  }
  
  retorno_esperado <- as.numeric(retornos_simulados[data,dia_previsto]) - as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])
   
  # separa qtde de acordo com lote minimo, no caso 100
  
  qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / preco.acoes.nivel$PETR4$Preco_bruto[data] /100 ) *100)
   
  if (retorno_esperado > 0 ){
     
    CARTEIRA <- compra_vende_acao("PETR4" ,data,qtde,CARTEIRA)
   
  }
  
  if (retorno_esperado < 0 ){
     
    CARTEIRA <- compra_vende_acao("PETR4" ,data,-qtde,CARTEIRA)
   
  }
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_11_1']] <<- CARTEIRA
  #return(carteira)
  
}

#####

# 12) Venda de acao seguindo previsao do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 25 dias. #####

# # estrategia_12_1 : usa a previsão da varição dos sigmas até o VENCIMENTO das opções comprada/vendida feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_12_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # paramentro de exposicao do patrimonio da carteira
  
  exposicao <- 1
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_vencimento_na_compra])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_vencimento])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
         (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  
  
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                       (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # separa qtde de acordo com lote minimo, no caso 100
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)   ){
    
    # Pega os dias para exercicio da opcao para calculo da variacao do sigma
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_exercicio])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_12_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_12_2 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_12_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_12_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_12_3 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_12_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_12_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_12_4 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_12_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  print(vencimento_put)
  print(nrow(CARTEIRA$portifolio$put))
  print(nrow(CALLS_DIA_LIMPO))
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    print(1)
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_12_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_12_5 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_12_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]

  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_12_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_12_6 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_12_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_12_6']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_12_7 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_12_7 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_12_7']] <<- CARTEIRA
  #return(carteira)
  
}



#####

# 13) Venda de acao seguindo previsao do SIGMA pelo garch. Procurando opções com o vencimento mais proximo de 50 dias.  #####

# # estrategia_13_1 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 50 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_13_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~50 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_13_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_13_2 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 50 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_13_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  #####
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
    
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_13_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_13_3 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 50 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_13_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_13_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_13_4 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 50 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_13_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_13_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_13_5 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 50 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_13_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_13_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_13_6 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 50 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_13_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_13_6']] <<- CARTEIRA
  #return(carteira)
  
}


#####

# 14) Venda de acao seguindo previsao do SIGMA pelo garch. Procurando opções com o vencimento mais proximo de 80 dias.  #####

# # estrategia_14_1 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 80 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_14_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~50 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_14_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_14_2 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 80 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_14_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  #####
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_14_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_14_3 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 80 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_14_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_14_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_14_4 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 80 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_14_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_14_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_14_5 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 80 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_14_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_14_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_14_6 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 80 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_14_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_14_6']] <<- CARTEIRA
  #return(carteira)
  
}


#####

# 15) Venda de acao seguindo previsao do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 1 dia. #####

# # estrategia_15_1 : usa a previsão da varição dos sigmas até o VENCIMENTO das opções comprada/vendida feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 1 dia.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_15_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # separa o vencimento ótimo para vender os puts ~1 dias
  vencimento_otimo <- 1
  
  # paramentro de exposicao do patrimonio da carteira
  
  exposicao <- 1
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_vencimento_na_compra])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_vencimento])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # separa qtde de acordo com lote minimo, no caso 100
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)   ){
    
    # Pega os dias para exercicio da opcao para calculo da variacao do sigma
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_exercicio])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_15_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_15_2 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 1 dia.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_15_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_15_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_15_3 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 1 dia.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_15_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_15_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_15_4 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 1 dia.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_15_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_15_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_15_5 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 1 dia.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_15_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_15_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_15_6 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 1 dia.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_15_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_15_6']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_15_7 : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 1 dia.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_15_7 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_15_7']] <<- CARTEIRA
  #return(carteira)
  
}



#####

# 16) Venda de acao seguindo previsao t = 2 do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 25 dias.
#####
  

# # estrategia_16_1 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_16_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_16_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_16_2 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_16_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_16_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_16_3 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_16_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_16_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_16_4 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_16_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_16_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_16_5 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_16_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_16_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_16_6 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_16_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_16_6']] <<- CARTEIRA
  #return(carteira)
  
}



#####


# 17) Venda de acao seguindo previsao t = 2 do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 50 dias.
#####


# # estrategia_17_1 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_17_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_17_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_17_2 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_17_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_17_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_17_3 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_17_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_17_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_17_4 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_17_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_17_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_17_5 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_17_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_17_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_17_6 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_17_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_17_6']] <<- CARTEIRA
  #return(carteira)
  
}

#####

# 18) Venda de acao seguindo previsao t = 2 do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 80 dias.
#####


# # estrategia_18_1 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_18_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_18_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_18_2 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_18_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_18_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_18_3 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_18_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_18_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_18_4 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_18_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_18_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_18_5 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_18_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_18_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_18_6 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_18_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_18_6']] <<- CARTEIRA
  #return(carteira)
  
}

#####


# 19) Venda de acao seguindo previsao t = 2 do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 1 dia.
#####


# # estrategia_19_1 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_19_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_19_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_19_2 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_19_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_19_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_19_3 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_19_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_19_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_19_4 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_19_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_19_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_19_5 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_19_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_19_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_19_6 : usa a previsão da varição dos sigmas para o 2 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_19_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 2
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_19_6']] <<- CARTEIRA
  #return(carteira)
  
}

#####

# 20) Venda de acao seguindo previsao t = 3 do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 50 dias.
#####


# # estrategia_20_1 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_20_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_20_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_20_2 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_20_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_20_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_20_3 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_20_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_20_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_20_4 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_20_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_20_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_20_5 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_20_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_20_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_20_6 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_20_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 50
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_20_6']] <<- CARTEIRA
  #return(carteira)
  
}

#####

# 21) Venda de acao seguindo previsao t = 3 do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 80 dias.
#####


# # estrategia_21_1 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_21_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_21_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_21_2 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_21_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_21_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_21_3 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_21_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_21_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_21_4 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_21_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_21_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_21_5 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_21_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_21_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_21_6 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_21_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 80
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_21_6']] <<- CARTEIRA
  #return(carteira)
  
}

#####


# 22) Venda de acao seguindo previsao t = 3 do SIGMA pelo GARCH. Procurando opções com o vencimento mais proximo de 1 dia.
#####


# # estrategia_22_1 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 500 reais do caixa. )

estrategia_22_1 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .5
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      # TODO : modificar para nao fechar o hedge de calda
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0) ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_22_1']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_22_2 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 600 reais do caixa. )

estrategia_22_2 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  #print(CARTEIRA$portifolio)
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .6
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  #####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_22_2']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_22_3 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 700 reais do caixa. )

estrategia_22_3 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .7
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put 
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_22_3']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_22_4 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 800 reais do caixa. )

estrategia_22_4 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .8
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_22_4']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_22_5 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 900 reais do caixa. )

estrategia_22_5 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- .9
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_22_5']] <<- CARTEIRA
  #return(carteira)
  
}

# # estrategia_22_6 : usa a previsão da varição dos sigmas para o 3 DIAS a frente feito pelo
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_22_6 <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 1
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 3
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
           (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
      # Fechando a posicao de PUT #####
      
      qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
      
      ticket_put <- CARTEIRA$portifolio$puts$ativo
      
      CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Put...",qtde_put))
      
      #####
      
      
      # Fechando a posicao de CALL #####
      
      qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
      
      ticket_call <- CARTEIRA$portifolio$calls$ativo
      
      CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
      
      print(paste0("...fechou posicao de Call...",qtde_call))
      
      #####
      
    }
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_22_6']] <<- CARTEIRA
  #return(carteira)
  
}

#####


# # estrategia_x : usa a previsão da varição dos sigmas para o DIA SEGUINTE feito pelo 
# gjrGARCH(3,3, dist = std, com média)-ARMA(2,2) ( não sei se é esse modelo de fato que vou usar ainda ) 
# para comprar ou vender um straddle. Procura CALL e PUT com o mesmo vencimento, e o mais proximo de 25 dias.
# se existe uma mudança na variação do sigma enquanto as OPÇÕES estão em carteira, a estratégia envia um sinal
# para fechar a posição. A quantidade de OPÇÕES compradas é determinada pelo valor em caixa suficiente para cobrir
# o dobro das quantidade de PUT vendido ( ex.: 1000 reais em caixa, vende-se( ou compra, mas ai não precisa ser 
# coberto) PUT coberto suficiente para comprometer 1000 reais do caixa. )

estrategia_x <- function(CALLS_DIA,PUTS_DIA,CARTEIRA,Fator_correcao_TEMPORARIO){
  
  # Parametros ####
  
  # Exposicao do patrimonio ao PUT e CALL vendido 
  exposicao <- 1
  
  # separa o vencimento ótimo para vender os puts ~25 dias
  vencimento_otimo <- 25
  
  # dias definidos para revisar a projeção do SIGMA
  dias_para_revisao <- 1
  
  ####
  
  # checa se tem acao comprada pra fechar posicao #####
  if(  nrow(CARTEIRA$portifolio$acoes)>0 ){
    CARTEIRA <- compra_vende_acao(CARTEIRA$portifolio$acoes$ativo,data,-as.numeric(CARTEIRA$portifolio$acoes$qtde),CARTEIRA)
  }
  
  ####
  
  
  
  # Verificando se ocorreu mudança na previsão da volatilidade para fechar ou abrir a posicao atual da carteira ####
  
  if ( nrow( CARTEIRA$portifolio$puts ) > 0) {
    
    # separa entre os dias para vencimento da compra e atual
    #dias_para_vencimento <- as.numeric(CARTEIRA$portifolio$puts$dias_para_vencimento) 
    
    #dias_para_vencimento_na_compra <- as.Date(CARTEIRA$portifolio$puts$vencimento)- as.Date(CARTEIRA$portifolio$puts$data)
    
    # usa os dias para vencimento da compra e atual para o calculo na alteracao da projeção
    
    #variacao_volatilidade_na_compra <- as.numeric(Zigmas_forcasted_todos[as.Date(CARTEIRA$portifolio$puts$data),dias_para_revisao])-as.numeric(Sigmas[as.Date(CARTEIRA$portifolio$puts$data)])
    
    #variacao_volatilidade_atual <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    #print(paste0("Variacao na Volatilidade prevista atual : ",variacao_volatilidade_atual ))
    
    #print(paste0("Variacao na Volatilidade prevista na compra : ",variacao_volatilidade_na_compra ))
    
    #if ( !((variacao_volatilidade_na_compra > 0) & (variacao_volatilidade_atual > 0)  |
    #       (variacao_volatilidade_na_compra < 0) & (variacao_volatilidade_atual < 0) )){
      
    # Fechando a posicao de PUT #####
    
    qtde_put <- -as.numeric(CARTEIRA$portifolio$puts$qtde)
    
    ticket_put <- CARTEIRA$portifolio$puts$ativo
    
    CARTEIRA <- compra_vende_put(ticket_put,qtde_put,PUTS_DIA,CARTEIRA)
    
    print(paste0("...fechou posicao de Put...",qtde_put))
    
    #####
    
    
    # Fechando a posicao de CALL #####
    
    qtde_call <- -as.numeric(CARTEIRA$portifolio$calls$qtde)
    
    ticket_call <- CARTEIRA$portifolio$calls$ativo
    
    CARTEIRA <- compra_vende_call(ticket_call,qtde_call,CALLS_DIA,CARTEIRA)
    
    print(paste0("...fechou posicao de Call...",qtde_call))
    
    #####
    
  #}
    
    
  }
  
  #####
  
  
  # Tirando os puts com preco simulado ( motivo é para manter o backtesting proximo do preco do mercado) ####
  
  PUTS_DIA <- PUTS_DIA[which((PUTS_DIA$data_ult_atualizacao == 0)),]
  
  CALLS_DIA <- CALLS_DIA[which((CALLS_DIA$data_ult_atualizacao == 0)),]
  
  # parametros da restricao
  prob_maior_igual <- .01
  premio_maior_igual <- .01
  
  #### 
  
  # Separa os PUTS #####
  
  PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                       (PUTS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                       (PUTS_DIA$dias_para_vencimento != 0 ) & 
                                       (PUTS_DIA$dias_para_vencimento <= 120 )) , ] 
  
  #PUTS_DIA_LIMPO <- PUTS_DIA[ which( (PUTS_DIA$prob_de_nao_exercer >= prob_maior_igual ) & 
  dias_para_exercicio <-unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
  PUTS_DIA_LIMPO <- PUTS_DIA_LIMPO[which(PUTS_DIA_LIMPO$dias_para_vencimento == dias_para_exercicio  ),]
  
  
  PUTS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-PUTS_DIA_LIMPO$strike) 
  
  ticket_put <- PUTS_DIA_LIMPO$ativo[which.min(PUTS_DIA_LIMPO$DIS)]
  
  # pegando vencimento do PUT para comprar/vender CALL com mesmo vencimento
  vencimento_put <- PUTS_DIA_LIMPO$vencimento[which.min(PUTS_DIA_LIMPO$DIS)]
  
  ######
  
  # Separa os CALLS #####
  
  CALLS_DIA_LIMPO <- CALLS_DIA[ which( (CALLS_DIA$prob_de_nao_exercer_no_dia >= prob_maior_igual ) & 
                                         (CALLS_DIA$prob_de_nao_exercer_no_dia != "NÃO_CALCULADO") &
                                         (CALLS_DIA$dias_para_vencimento != 0 ) & 
                                         (CALLS_DIA$vencimento == vencimento_put)) , ] 
  
  CALLS_DIA_LIMPO$DIS <- abs(as.numeric(preco.acoes.nivel$PETR4$Preco_bruto[data])-CALLS_DIA_LIMPO$strike) 
  
  
  ticket_call <- CALLS_DIA_LIMPO$ativo[which.min(CALLS_DIA_LIMPO$DIS)]
  
  #####
  
  
  # Prepara a compra ou venda das opcoes ####
  
  if ((nrow(PUTS_DIA_LIMPO) > 0) & (nrow(CARTEIRA$portifolio$put) == 0) & (nrow(CALLS_DIA_LIMPO) > 0)  ){
    
    dias_para_exercicio <- unique(PUTS_DIA_LIMPO$dias_para_vencimento)[which.min(abs(unique(PUTS_DIA_LIMPO$dias_para_vencimento) - vencimento_otimo))]
    
    # dias_para_revisao é o dia para qual se deseja prever o SIGMA
    
    variacao_volatilidade <- as.numeric(Zigmas_forcasted_todos[data,dias_para_revisao])-as.numeric(Sigmas[data])
    
    print(paste0("Volatilidade : ", variacao_volatilidade))
    print(paste0("Puts Limpos : ",nrow(PUTS_DIA_LIMPO)))
    
    # aposta a FAVOR da voltalidade #####
    
    if (variacao_volatilidade > 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # Compra PUT e CALL se tem dinheiro #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de compra
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # compra PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Put...",qtde*exposicao))
            
            ####
            
            # compra CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Comprou Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
    }
    
    
    #####
    
    # aposta CONTRA a voltalidade #####
    
    if (variacao_volatilidade < 0){
      
      qtde <- as.numeric(floor( ( (CARTEIRA$cash + CARTEIRA$cash_d_1 + CARTEIRA$cash_d_2 + CARTEIRA$cash_d_3) - CARTEIRA$garantia ) / PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)] /100 ) *100)*exposicao
      
      # vende PUT e CALL se tem garantia #####
      if ( length(qtde) != 0 ){
        
        # garante que tenha ordem de venda
        if (qtde != 0 ){
          # condicional de se tem dinheiro na carteira
          if ( (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= PUTS_DIA_LIMPO$strike[which.min(PUTS_DIA_LIMPO$DIS)]*(qtde/2) ) &
               (( (CARTEIRA$cash + CARTEIRA$cash_d_1 +CARTEIRA$cash_d_2 +CARTEIRA$cash_d_3 + CARTEIRA$garantia )/2)*exposicao >= CALLS_DIA_LIMPO$strike[which.min(CALLS_DIA_LIMPO$DIS)]*(qtde/2) ))  {
            
            # vende PUT se tem dinheiro #####
            
            CARTEIRA <- compra_vende_put(ticket_put,-qtde*exposicao,PUTS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Put...",qtde*exposicao))
            
            ####
            
            # vende CALL se tem dinheiro #####
            
            CARTEIRA <- compra_vende_call(ticket_call,-qtde*exposicao,CALLS_DIA,CARTEIRA)
            
            print(paste0("...Vendeu Call...",qtde*exposicao))
            
            ####
            
          }
        }
      }
      
      #####
      
      
    }
    
    #####
  }
  
  #####
  
  # calcula garantia necessaria para exercicio de puts... desconsidera compra de put ####
  
  if ( nrow(CARTEIRA$portifolio$puts) >= 1 ){
    CARTEIRA$garantia <- as.numeric( t(CARTEIRA$portifolio$puts$qtde[which(CARTEIRA$portifolio$puts$qtde < 0 )]) %*% CARTEIRA$portifolio$puts$strike[which(CARTEIRA$portifolio$puts$qtde < 0 )])
    print("...calculou garantia...")
  } else {
    CARTEIRA$garantia <- 0
  }
  #####
  
  # finalizando
  
  CARTEIRA$dia <- data
  
  #assign(deparse(match.call()$CARTEIRA), CARTEIRA, envir = .GlobalEnv)
  carteiras[['estrategia_x']] <<- CARTEIRA
  #return(carteira)
  
}




estrategias <- list(estrategia_1_1 = estrategia_1_1,estrategia_x = estrategia_x) 

#estrategias <- list(estrategia_1_1 = estrategia_1_1,
#                    estrategia_12_4 = estrategia_12_4,estrategia_13_4 = estrategia_13_4,
#                    estrategia_14_4 = estrategia_14_4,estrategia_15_4 = estrategia_15_4,
#                    estrategia_16_4 = estrategia_16_4,estrategia_17_4 = estrategia_17_4,
#                    estrategia_18_4 = estrategia_18_4,estrategia_19_4 = estrategia_19_4,
#                    estrategia_20_4 = estrategia_20_4,estrategia_21_4 = estrategia_21_4,
#                    estrategia_22_4 = estrategia_22_4)


#estrategias <- list(estrategia_1_1 = estrategia_1_1,estrategia_10_1 = estrategia_10_1 ,
#                    estrategia_10_2 = estrategia_10_2 ,estrategia_10_3 = estrategia_10_3 ,
#                    estrategia_10_4 = estrategia_10_4 ,estrategia_10_5 = estrategia_10_5 ,
#                    estrategia_x_1 = estrategia_x_1)

# estratégias de 1 a 3 são as 100 estratégias iniciais que foram testadas inicialmentes no perido de "2006-01-12" a "2010-02-05". 
# estratégia melhores são as melhores ( melhor indice de sharp) escolhidas após o primeiro backtesting 
estrategias_1 <- list(estrategia_1_1 = estrategia_1_1,estrategia_1_2 = estrategia_1_2,estrategia_1_3 = estrategia_1_3,estrategia_1_4 = estrategia_1_4,
                    estrategia_2_1 = estrategia_2_1,estrategia_2_2 = estrategia_2_2,estrategia_2_3 = estrategia_2_3,estrategia_2_4 = estrategia_2_4,
                    estrategia_3_1 = estrategia_3_1,estrategia_3_2 = estrategia_3_2,estrategia_3_3 = estrategia_3_3,estrategia_3_4 = estrategia_3_4,
                    estrategia_4_1 = estrategia_4_1,estrategia_4_2 = estrategia_4_2,estrategia_4_3 = estrategia_4_3,estrategia_4_4 = estrategia_4_4,
                    estrategia_5_1 = estrategia_5_1,estrategia_5_2 = estrategia_5_2,estrategia_5_3 = estrategia_5_3,estrategia_5_4 = estrategia_5_4,
                    estrategia_6_1 = estrategia_6_1,estrategia_6_2 = estrategia_6_2,estrategia_6_3 = estrategia_6_3,estrategia_6_4 = estrategia_6_4,
                    estrategia_7_1 = estrategia_7_1,estrategia_7_2 = estrategia_7_2,estrategia_7_3 = estrategia_7_3,estrategia_7_4 = estrategia_7_4,
                    estrategia_8_1 = estrategia_8_1,estrategia_8_2 = estrategia_8_2,estrategia_8_3 = estrategia_8_3,estrategia_8_4 = estrategia_8_4,
                    estrategia_9_1 = estrategia_9_1,estrategia_9_2 = estrategia_9_2,estrategia_9_3 = estrategia_9_3,estrategia_9_4 = estrategia_9_4)

estrategias_2 <- list(estrategia_10_1 = estrategia_10_1 ,estrategia_10_2 = estrategia_10_2 ,estrategia_10_3 = estrategia_10_3 ,
                    estrategia_10_4 = estrategia_10_4, estrategia_10_5 = estrategia_10_5 , estrategia_11_1 = estrategia_11_1,
                    estrategia_12_1 = estrategia_12_1, estrategia_12_2 = estrategia_12_2, estrategia_12_3 = estrategia_12_3 ,
                    estrategia_12_4 = estrategia_12_4,estrategia_12_5 = estrategia_12_5  ,estrategia_12_6 = estrategia_12_6,
                    estrategia_12_7 = estrategia_12_7 ,
                    estrategia_13_1 = estrategia_13_1, estrategia_13_2 = estrategia_13_2, estrategia_13_3 = estrategia_13_3 ,
                    estrategia_13_4 = estrategia_13_4,estrategia_13_5 = estrategia_13_5  ,estrategia_13_6 = estrategia_13_6,
                    estrategia_14_1 = estrategia_14_1, estrategia_14_2 = estrategia_14_2, estrategia_14_3 = estrategia_14_3 ,
                    estrategia_14_4 = estrategia_14_4,estrategia_14_5 = estrategia_14_5  ,estrategia_14_6 = estrategia_14_6,
                    estrategia_15_1 = estrategia_15_1, estrategia_15_2 = estrategia_15_2, estrategia_15_3 = estrategia_15_3 ,
                    estrategia_15_4 = estrategia_15_4,estrategia_15_5 = estrategia_15_5  ,estrategia_15_6 = estrategia_15_6,
                    estrategia_16_1 = estrategia_16_1, estrategia_16_2 = estrategia_16_2, estrategia_16_3 = estrategia_16_3 ,
                    estrategia_16_4 = estrategia_16_4,estrategia_16_5 = estrategia_16_5  ,estrategia_16_6 = estrategia_16_6)


estrategias_3 <- list(estrategia_17_1 = estrategia_17_1, estrategia_17_2 = estrategia_17_2, estrategia_17_3 = estrategia_17_3 ,
                    estrategia_17_4 = estrategia_17_4,estrategia_17_5 = estrategia_17_5  ,estrategia_17_6 = estrategia_17_6,
                    estrategia_18_1 = estrategia_18_1, estrategia_18_2 = estrategia_18_2, estrategia_18_3 = estrategia_18_3 ,
                    estrategia_18_4 = estrategia_18_4,estrategia_18_5 = estrategia_18_5  ,estrategia_18_6 = estrategia_18_6,
                    estrategia_19_1 = estrategia_19_1, estrategia_19_2 = estrategia_19_2, estrategia_19_3 = estrategia_19_3 ,
                    estrategia_19_4 = estrategia_19_4,estrategia_19_5 = estrategia_19_5  ,estrategia_19_6 = estrategia_19_6,
                    estrategia_20_1 = estrategia_20_1, estrategia_20_2 = estrategia_20_2, estrategia_20_3 = estrategia_20_3 ,
                    estrategia_20_4 = estrategia_20_4,estrategia_20_5 = estrategia_20_5  ,estrategia_20_6 = estrategia_20_6,
                    estrategia_21_1 = estrategia_21_1, estrategia_21_2 = estrategia_21_2, estrategia_21_3 = estrategia_21_3 ,
                    estrategia_21_4 = estrategia_21_4,estrategia_21_5 = estrategia_21_5  ,estrategia_21_6 = estrategia_21_6,
                    estrategia_22_1 = estrategia_22_1, estrategia_22_2 = estrategia_22_2, estrategia_22_3 = estrategia_22_3 ,
                    estrategia_22_4 = estrategia_22_4,estrategia_22_5 = estrategia_22_5  ,estrategia_22_6 = estrategia_22_6)




# melhores estratégias separadas por retorno e melhores sortinos

estrategias_melhores <- list(estrategia_13_6 = estrategia_13_6 ,
                    estrategia_10_4	= estrategia_10_4	,
                    estrategia_10_5	= estrategia_10_5	,
                    estrategia_13_5 = estrategia_13_5 , 
                    estrategia_14_6	= estrategia_14_6	,
                    estrategia_13_4	= estrategia_13_4 ,
                    estrategia_12_7	= estrategia_12_7	,
                    estrategia_10_3	= estrategia_10_3 ,
                    estrategia_12_6	= estrategia_12_6 ,
                    estrategia_8_2	= estrategia_8_2 ,
                    estrategia_17_6	= estrategia_17_6 ,
                    estrategia_12_5 = estrategia_12_5 ,
                    estrategia_12_1	= estrategia_12_1 ,
                    estrategia_15_1 = estrategia_15_1 ,
                    estrategia_8_1  = estrategia_8_1 ,
                    estrategia_14_5 = estrategia_14_5,
                    estrategia_15_4 = estrategia_15_4,
                    estrategia_13_3 = estrategia_13_3,
                    estrategia_12_4 = estrategia_12_4,
                    estrategia_13_2 = estrategia_13_2,
                    estrategia_15_5 = estrategia_15_5,
                    estrategia_15_3 = estrategia_15_3,
                    estrategia_12_3 = estrategia_12_3)



